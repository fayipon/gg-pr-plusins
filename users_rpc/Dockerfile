# syntax=docker/dockerfile:1

##############################################
# ğŸ§± Builder éšæ®µï¼šä½¿ç”¨ Go å®˜æ–¹é¡åƒæ§‹å»ºäºŒé€²åˆ¶
##############################################
FROM golang:1.25-alpine AS builder

WORKDIR /app
ENV CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    GOMODCACHE=/go/pkg/mod \
    GOPROXY=https://proxy.golang.org,direct

# å®‰è£å¿…è¦å·¥å…·
RUN apk add --no-cache git tzdata

# ğŸ§© é å…ˆå»ºç«‹ module cacheï¼ˆæå‡é‡å»ºé€Ÿåº¦ï¼‰
COPY go.mod go.sum ./
RUN go mod download

# ğŸ§© å†è¤‡è£½æºç¢¼
COPY . .

# ğŸ§± å»ºæ§‹ users_rpc äºŒé€²ä½æª”
RUN go build -ldflags="-s -w" -o users_rpc users.go


##############################################
# ğŸš€ Runtime éšæ®µï¼šæœ€å°åŒ–é¡åƒé«”ç©
##############################################
FROM alpine:3.19

WORKDIR /app
ENV TZ=Asia/Manila
RUN apk add --no-cache tzdata ca-certificates && update-ca-certificates

# æ‹·è²åŸ·è¡Œæª”èˆ‡é…ç½®
COPY --from=builder /app/users_rpc ./users_rpc
COPY --from=builder /app/etc ./etc

EXPOSE 9107

# ğŸŸ© æœ€ä½³å¯¦è¸ï¼šä½¿ç”¨ ENTRYPOINT é¿å… shell å•é¡Œ
ENTRYPOINT ["./users_rpc", "-f", "etc/users.yaml"]
