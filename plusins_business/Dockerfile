# syntax=docker/dockerfile:1

##############################
# ğŸ§± Build éšæ®µ
##############################
FROM golang:1.25-alpine AS builder
WORKDIR /app

# å®‰è£å¿…è¦å·¥å…·
RUN apk add --no-cache git tzdata ca-certificates

# âœ… é å…ˆè¤‡è£½ go.mod / go.sum ä»¥åˆ©ç”¨ Docker layer cache
COPY go.mod go.sum ./
RUN go mod download

# âœ… å†è¤‡è£½å°ˆæ¡ˆä»£ç¢¼
COPY . .

# âœ… åŠ å…¥ç’°å¢ƒè®Šæ•¸èˆ‡å¿«å–è¨­å®š
ENV CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    GOMODCACHE=/go/pkg/mod \
    GOPROXY=https://proxy.golang.org,direct

# âœ… ç·¨è­¯å¯åŸ·è¡Œæª”ï¼ˆstrip debug symbols æ¸›å°‘é«”ç©ï¼‰
RUN go build -ldflags="-s -w" -o plusins_business plusins_business.go


##############################
# ğŸš€ Runtime éšæ®µ
##############################
FROM alpine:3.19
WORKDIR /app

# å®‰è£æ™‚å€èˆ‡æ†‘è­‰
RUN apk add --no-cache tzdata ca-certificates && update-ca-certificates

# æ‹·è²åŸ·è¡Œæª”èˆ‡é…ç½®
COPY --from=builder /app/plusins_business ./plusins_business
COPY --from=builder /app/etc ./etc

# è¨­å®šæ™‚å€
ENV TZ=Asia/Manila

# é–‹æ”¾ç«¯å£ï¼ˆâš™ï¸ æ¯” plusins_api å¤šä¸€è™Ÿï¼‰
EXPOSE 8082

# å•Ÿå‹•æœå‹™
CMD ["./plusins_business", "-f", "etc/plusins_business.yaml"]