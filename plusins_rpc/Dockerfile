# syntax=docker/dockerfile:1

##############################################
# ğŸ§± Builder éšæ®µï¼šä½¿ç”¨ Go å®˜æ–¹é¡åƒæ§‹å»ºäºŒé€²åˆ¶
##############################################
FROM golang:1.25-alpine AS builder

WORKDIR /app
ENV CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    GOMODCACHE=/go/pkg/mod \
    GOPROXY=https://proxy.golang.org,direct

# å®‰è£å¿…è¦å·¥å…·
RUN apk add --no-cache git tzdata

# ğŸ§© é å…ˆå»ºç«‹ module cacheï¼ˆæ¥µå¤§å¹…æå‡é‡å»ºé€Ÿåº¦ï¼‰
COPY go.mod go.sum ./
RUN go mod download

# ğŸ§© å†è¤‡è£½æºç¢¼
COPY . .

# ğŸ§± å»ºæ§‹äºŒé€²åˆ¶æª”
RUN go build -ldflags="-s -w" -o plusins_rpc plusins_rpc.go


##############################################
# ğŸš€ Runtime éšæ®µï¼šæœ€å°åŒ–é¡åƒé«”ç©
##############################################
FROM alpine:3.19

WORKDIR /app
ENV TZ=Asia/Manila
RUN apk add --no-cache tzdata ca-certificates && update-ca-certificates

# æ‹·è²åŸ·è¡Œæª”èˆ‡é…ç½®
COPY --from=builder /app/plusins_rpc ./
COPY --from=builder /app/etc ./etc

EXPOSE 9103

# âœ… æœ€ä½³å¯¦è¸ï¼šä¸ä½¿ç”¨ shellï¼Œä»¥é˜² ENTRYPOINT å•é¡Œ
ENTRYPOINT ["./plusins_rpc", "-f", "etc/plusins.yaml"]
